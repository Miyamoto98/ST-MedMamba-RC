# RectSurgNet 工具脚本说明

此目录包含为 `RectSurgNet` 项目提供数据预处理、格式转换、模型评估和数据集管理等功能的实用工具脚本。

---

## 脚本功能详解

### 1. `pre_CT_MR.py`

- **功能**: **3D医学图像 (CT/MR) 预处理脚本**
- **详细描述**:
    - **输入**: NIfTI 格式的3D图像 (`.nii.gz`) 和对应的标签（ground truth）。
    - **处理流程**:
        1.  **强度归一化**: 对CT图像应用窗宽窗位（Windowing）调整；对MR图像应用百分位裁剪进行归一化，以增强对比度。
        2.  **标签清洗**: 使用 `cc3d` (Connected Components 3D) 库移除标签中体积过小的三维连通域和面积过小的二维连通域（噪声），保留有意义的结构。
        3.  **实例分割转换**: 可选地将语义分割标签（如单个“肿瘤”类别）转换为实例分割标签，即为每个独立的肿瘤分配一个唯一的ID。
        4.  **ROI提取**: 自动检测包含标签的有效切片（z-axis），并裁剪出对应的图像和标签区域（Region of Interest, ROI），去除无关的空白背景切片。
        5.  **数据保存**:
            - 将处理后的3D图像和标签数据打包保存为压缩的 `.npz` 文件。
            - 将每个2D切片分别 resize 到 `1024x1024`，并保存为独立的 `.npy` 文件，用于后续的2D模型训练。

### 2. `pre_grey_rgb.py`

- **功能**: **2D图像 (灰度/RGB) 预处理脚本**
- **详细描述**:
    - **输入**: 常见的2D图像格式（如 `.png`, `.jpg`）及其对应的标签图。
    - **处理流程**:
        1.  **通道转换**: 确保所有输入图像为三通道RGB格式。如果输入是单通道灰度图，会自动复制通道进行转换。
        2.  **实例分割转换**: 与 `pre_CT_MR.py` 类似，可以将语义标签转换为实例标签。
        3.  **尺寸统一**: 将图像和标签都 resize 到 `1024x1024`。
        4.  **数据保存**: 将处理后的图像和标签分别保存为 `.npy` 文件，用于模型训练。

### 3. `format_convert.py`

- **功能**: **多功能格式转换工具集**
- **详细描述**: 提供了一系列函数用于在不同数据格式间进行转换。
    - **医学图像格式转换**:
        - `dcm2nii`: DICOM (`.dcm` 序列) -> NIfTI (`.nii`)
        - `mhd2nii`: MetaHeader (`.mhd`) -> NIfTI (`.nii`)
        - `nrrd2nii`: Nearly Raw Raster Data (`.nrrd`) -> NIfTI (`.nii`)
    - **图像分块 (`patchfy`)**: 将超大分辨率的整张图像（Whole Slide Image）及其标签切割成 `1024x1024` 的小块（patches），便于送入模型进行训练。
    - **RLE解码 (`rle_decode`)**: 将游程编码（Run-Length Encoding）格式的标签解码为二值的掩码（mask）图像。

### 4. `split.py`

- **功能**: **数据集划分脚本**
- **详细描述**:
    - 用于将整理好的数据集随机划分为训练集、验证集和测试集。
    - 支持三种数据类型：3D NIfTI 数据、2D 图像数据和视频数据。
    - 默认按 8:1:1 的比例划分，从总数据中随机抽取20%作为测试和验证候选，再从中均分。
    - 脚本会自动创建 `validation` 和 `testing` 文件夹，并将划分好的文件移动到相应位置。

### 5. `SurfaceDice.py`

- **功能**: **3D分割评估指标计算脚本**
- **详细描述**:
    - 实现了比传统 Dice 系数更关注边界分割质量的评估指标。
    - **核心指标**:
        - **Surface Dice (表面Dice系数)**: 在给定容差（tolerance）下，衡量预测表面与真实表面的重合度。
        - **Average Surface Distance (ASD, 平均表面距离)**: 计算两个表面之间的平均距离。
        - **Robust Hausdorff Distance (鲁棒豪斯多夫距离)**: 通常计算95%分位的豪斯多夫距离，以排除离群点的影响，更稳定地评估模型在最差情况下的表现。
    - 此脚本对于评估器官、肿瘤等需要精确边界分割的任务至关重要。

### 6. `ckpt_convert.py`

- **功能**: **模型权重转换脚本**
- **详细描述**:
    - 用于将 `MedSAM` (Medical Segment Anything Model) 的模型检查点（checkpoint）文件转换为与原始 `SAM` 模型兼容的格式。
    - 主要解决了因模型结构或多GPU训练导致的权重字典键名不匹配问题，方便进行推理或微调。
